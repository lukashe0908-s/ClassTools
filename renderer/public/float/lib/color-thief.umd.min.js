!function(t,o){"object"==typeof exports&&"undefined"!=typeof module?module.exports=o():"function"==typeof define&&define.amd?define(o):(t||self).ColorThief=o()}(this,function(){function C(t,o){return t<o?-1:o<t?1:0}function r(t){return t.reduce(function(t,o){return t+o},0)}function e(t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=this.canvas.width=t.naturalWidth,this.height=this.canvas.height=t.naturalHeight,this.context.drawImage(t,0,0,this.width,this.height)}var _=function(){function t(t){this.colors=t}var o=t.prototype;return o.palette=function(){return this.colors},o.map=function(t){return t},t}(),u=(M.prototype={volume:function(t){var o=this;return o._volume&&!t||(o._volume=(o.r2-o.r1+1)*(o.g2-o.g1+1)*(o.b2-o.b1+1)),o._volume},count:function(t){var o=this,n=o.histo;if(!o._count_set||t){for(var r,e,i=0,u=o.r1;u<=o.r2;u++)for(r=o.g1;r<=o.g2;r++)for(e=o.b1;e<=o.b2;e++)i+=n[E(u,r,e)]||0;o._count=i,o._count_set=!0}return o._count},copy:function(){var t=this;return new M(t.r1,t.r2,t.g1,t.g2,t.b1,t.b2,t.histo)},avg:function(t){var o=this,n=o.histo;if(!o._avg||t){var r,e,i,u,a=0,c=0,f=0,s=0;if(o.r1===o.r2&&o.g1===o.g2&&o.b1===o.b2)o._avg=[o.r1<<3,o.g1<<3,o.b1<<3];else{for(e=o.r1;e<=o.r2;e++)for(i=o.g1;i<=o.g2;i++)for(u=o.b1;u<=o.b2;u++)a+=r=n[E(e,i,u)]||0,c+=r*(e+.5)*8,f+=r*(i+.5)*8,s+=r*(u+.5)*8;o._avg=a?[~~(c/a),~~(f/a),~~(s/a)]:[~~(8*(o.r1+o.r2+1)/2),~~(8*(o.g1+o.g2+1)/2),~~(8*(o.b1+o.b2+1)/2)]}}return o._avg},contains:function(t){var o=this,n=t[0]>>3;return gval=t[1]>>3,bval=t[2]>>3,n>=o.r1&&n<=o.r2&&gval>=o.g1&&gval<=o.g2&&bval>=o.b1&&bval<=o.b2}},z.prototype={push:function(t){this.vboxes.push({vbox:t,color:t.avg()})},palette:function(){return this.vboxes.map(function(t){return t.color})},size:function(){return this.vboxes.size()},map:function(t){for(var o=this.vboxes,n=0;n<o.size();n++)if(o.peek(n).vbox.contains(t))return o.peek(n).color;return this.nearest(t)},nearest:function(t){for(var o,n,r,e=this.vboxes,i=0;i<e.size();i++)((n=Math.sqrt(Math.pow(t[0]-e.peek(i).color[0],2)+Math.pow(t[1]-e.peek(i).color[1],2)+Math.pow(t[2]-e.peek(i).color[2],2)))<o||void 0===o)&&(o=n,r=e.peek(i).color);return r},forcebw:function(){var t=this.vboxes,o=(t.sort(function(t,o){return C(r(t.color),r(o.color))}),t[0].color),o=(o[0]<5&&o[1]<5&&o[2]<5&&(t[0].color=[0,0,0]),t.length-1),n=t[o].color;251<n[0]&&251<n[1]&&251<n[2]&&(t[o].color=[255,255,255])}},function(t,o){if(!Number.isInteger(o)||o<1||256<o)throw new Error("Invalid maximum color count. It must be an integer between 1 and 256.");if(!t.length||o<2||256<o)return!1;if(!t.length||o<2||256<o)return!1;for(var n=[],r=new Set,e=0;e<t.length;e++){var i=t[e],u=i.join(",");r.has(u)||(r.add(u),n.push(i))}if(n.length<=o)return new _(n);d=t,c=new Array(32768),d.forEach(function(t){a=E(t[0]>>3,t[1]>>3,t[2]>>3),c[a]=(c[a]||0)+1});var a,c,f,s,h,l,g,v,p,b=c,d=(b.forEach(function(){}),d=b,v=l=s=1e6,p=g=h=0,t.forEach(function(t){(f=t[0]>>3)<s?s=f:h<f&&(h=f),(f=t[1]>>3)<l?l=f:g<f&&(g=f),(f=t[2]>>3)<v?v=f:p<f&&(p=f)}),new M(s,h,l,g,v,p,d)),m=new I(function(t,o){return C(t.count(),o.count())});function w(t,o){for(var n,r=t.size(),e=0;e<1e3;){if(o<=r)return;if(1e3<e++)return;if((n=t.pop()).count()){var i=function(t,o){if(o.count()){var n=o.r2-o.r1+1,r=o.g2-o.g1+1,e=Math.max.apply(null,[n,r,o.b2-o.b1+1]);if(1==o.count())return[o.copy()];var i,u,a,c,f=0,s=[],h=[];if(e==n)for(i=o.r1;i<=o.r2;i++){for(c=0,u=o.g1;u<=o.g2;u++)for(a=o.b1;a<=o.b2;a++)c+=t[E(i,u,a)]||0;s[i]=f+=c}else if(e==r)for(i=o.g1;i<=o.g2;i++){for(c=0,u=o.r1;u<=o.r2;u++)for(a=o.b1;a<=o.b2;a++)c+=t[E(u,i,a)]||0;s[i]=f+=c}else for(i=o.b1;i<=o.b2;i++){for(c=0,u=o.r1;u<=o.r2;u++)for(a=o.g1;a<=o.g2;a++)c+=t[E(u,a,i)]||0;s[i]=f+=c}s.forEach(function(t,o){h[o]=f-t});var l,g,v,p,b,n=e==n?"r":e==r?"g":"b",d=n+"1",m=n+"2",w=0;for(i=o[d];i<=o[m];i++)if(s[i]>f/2){for(v=o.copy(),p=o.copy(),b=(l=i-o[d])<=(g=o[m]-i)?Math.min(o[m]-1,~~(i+g/2)):Math.max(o[d],~~(i-1-l/2));!s[b];)b++;for(w=h[b];!w&&s[b-1];)w=h[--b];return v[m]=b,p[d]=v[m]+1,[v,p]}}}(b,n),u=i[0],i=i[1];if(!u)return;t.push(u),i&&(t.push(i),r++)}else t.push(n),e++}}m.push(d),w(m,.75*o);for(var y=new I(function(t,o){return C(t.count()*t.volume(),o.count()*o.volume())});m.size();)y.push(m.pop());w(y,o);for(var x=new z;y.size();)x.push(y.pop());return x});function E(t,o,n){return(t<<10)+(o<<5)+n}function I(t){var o=[],n=!1;function r(){o.sort(t),n=!0}return{push:function(t){o.push(t),n=!1},peek:function(t){return n||r(),void 0===t&&(t=o.length-1),o[t]},pop:function(){return n||r(),o.pop()},size:function(){return o.length},map:function(t){return o.map(t)},debug:function(){return n||r(),o}}}function M(t,o,n,r,e,i,u){var a=this;a.r1=t,a.r2=o,a.g1=n,a.g2=r,a.b1=e,a.b2=i,a.histo=u}function z(){this.vboxes=new I(function(t,o){return C(t.vbox.count()*t.vbox.volume(),o.vbox.count()*o.vbox.volume())})}e.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)};function t(){}return t.prototype.getColor=function(t,o){return this.getPalette(t,5,o=void 0===o?10:o)[0]},t.prototype.getPalette=function(t,o,n){o=function(t){var o=t.colorCount,t=t.quality;if(void 0!==o&&Number.isInteger(o)){if(1===o)throw new Error("colorCount should be between 2 and 20. To get one color, call getColor() instead of getPalette()");o=Math.max(o,2),o=Math.min(o,20)}else o=10;return{colorCount:o,quality:t=void 0===t||!Number.isInteger(t)||t<1?10:t}}({colorCount:o,quality:n}),n=new e(t),t=function(t,o,n){for(var r,e,i,u,a=t,c=[],f=0;f<o;f+=n)r=a[0+(u=4*f)],e=a[1+u],i=a[2+u],!(void 0===(u=a[3+u])||125<=u)||250<r&&250<e&&250<i||c.push([r,e,i]);return c}(n.getImageData().data,n.width*n.height,o.quality),n=u(t,o.colorCount);return n?n.palette():null},t.prototype.getColorFromUrl=function(o,n,r){var e=this,i=document.createElement("img");i.addEventListener("load",function(){var t=e.getPalette(i,5,r);n(t[0],o)}),i.src=o},t.prototype.getImageData=function(t,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="arraybuffer",o.onload=function(){if(200==this.status){var t=new Uint8Array(this.response);i=t.length;for(var o=new Array(i),n=0;n<t.length;n++)o[n]=String.fromCharCode(t[n]);var r=o.join(""),r=window.btoa(r);e("data:image/png;base64,"+r)}},o.send()},t.prototype.getColorAsync=function(t,n,r){var e=this;this.getImageData(t,function(t){var o=document.createElement("img");o.addEventListener("load",function(){var t=e.getPalette(o,5,r);n(t[0],this)}),o.src=t})},t});